# ViroForge Development Context

## Project Overview
Synthetic virome data generator for benchmarking/validation of virome analysis pipelines. Generates realistic Illumina reads with known ground truth.

## Current Status (Phase 1: ~80% Complete)

### ‚úÖ Implemented
- Community composition (5 body sites, 3 abundance distributions)
- Contamination profiles (4 levels: clean/realistic/heavy/failed)
- FASTQ generation (InSilicoSeq integration, NovaSeq/MiSeq/HiSeq)
- Validation framework (prevents seq/qual mismatches, file truncation)
- Ground truth tracking (complete metadata export)
- End-to-end testing (5/5 tests passing, 17,500 records validated)

### üéØ Next Phase (Phase 2: Virome-Specific Features)
**Approved Plan**: Community-focused, lab-agnostic implementation (12 weeks)
**See**: `docs/IMPLEMENTATION_PLAN.md` for full details

**Core Features to Implement**:
1. **VLP Enrichment Framework** (Weeks 1-3) - NEXT
   - Flexible, supports any VLP protocol
   - VLP vs bulk comparison capability

2. **Amplification Bias Framework** (Weeks 4-6)
   - RdAB, MDA, linker-based, no-amp

3. **Platform Artifacts** (Weeks 7-8)
   - NovaSeq (polyG tails, optical dups)
   - MiSeq/HiSeq variants

4. **Library Prep Methods** (Weeks 7-8)
   - Mechanical shearing, tagmentation

## Key Architecture Principles
- **Modular**: Each component independently testable
- **Composable**: Users mix-and-match components
- **Lab-agnostic**: Configurable for any protocol
- **Pre-defined templates**: Convenience wrappers for common workflows

## Important Files

### Core Code
- `viroforge/core/community.py` - Viral communities (892 lines)
- `viroforge/core/contamination.py` - Contamination (766 lines)
- `viroforge/utils/validation.py` - Quality control (686 lines)
- `viroforge/simulators/illumina.py` - FASTQ generation (850 lines)

### Documentation
- `docs/IMPLEMENTATION_PLAN.md` - Phase 2 detailed plan ‚≠ê
- `docs/STRATEGIC_REVIEW.md` - Scope analysis & options
- `docs/DESIGN_RATIONALE.md` - Original design (1,260 lines)
- `docs/VALIDATION.md` - Validation framework guide

### Testing
- `test_read_generation.py` - End-to-end tests (all passing)
- `tests/test_validation.py` - Unit tests (31/31 passing)

## Next Session Start

### Immediate Task
Begin VLP enrichment framework implementation (Week 1 of Phase 2)

### Implementation Order
1. Create `viroforge/enrichment.py` with base classes
2. Implement size-based filtration logic
3. Add nuclease treatment modeling
4. Create pre-defined VLP protocol templates
5. Write unit tests
6. Create example/tutorial

### Key Design Decision
**Flexible framework** (not hard-coded protocol):
```python
# Configurable for any lab
vlp = VLPEnrichment(
    filtration_cutoff_um=0.2,  # User-configurable
    nuclease_efficiency=0.95,
    method='tangential_flow'
)
vlp.apply(composition)
```

## Testing Requirements
- Unit tests for each component
- Integration tests for complete workflows
- Literature validation (match published ranges)
- VLP vs bulk comparison tests

## Success Criteria
- Lab-agnostic (works for community)
- Fully tested (>90% coverage)
- Well-documented (tutorials + API docs)
- Validated (matches literature)
- Publication-ready (Nature Biotechnology level)

## Dependencies
- InSilicoSeq 2.0.1 (installed in venv)
- BioPython 1.86
- pandas 2.5.1
- numpy 2.3.4

## Quick Reference
```bash
# Activate environment
source venv/bin/activate

# Run tests
python test_read_generation.py
pytest tests/test_validation.py -v

# Check imports
python -c "from viroforge.simulators import quick_generate; print('‚úì')"
```

## Recent Commits
- Phase 1 core modules (bd1925a)
- FASTQ generation (aea94ad)
- Bug fix & testing (6be0bdd, 8c2225c)
- Strategic review (12385a5)
- Implementation plan (3e96646) ‚≠ê

## Notes
- All synthetic sequences currently (N's) - real DB integration later
- InSilicoSeq counts fragments (10k reads = 5k pairs)
- Validation prevents FASTQ issues (0 errors in 17,500 records tested)
