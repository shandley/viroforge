# ViroForge Development Context

## Project Overview
Synthetic virome data generator for benchmarking and validation of virome analysis pipelines. Generates realistic Illumina reads with known ground truth from curated viral genome collections.

## Current Status

### Completed Phases
- Phase 1: Community composition and contamination (100%)
- Phase 2: VLP enrichment and virome-specific features (100%)
- Phase 3: Genome database and body site collections (100%)
- Phase 4: Database-driven FASTQ generation (100%)
- Phase 5: Enhanced VLP modeling with size-based filtration (100%)

### Production Ready Features
- 14,423 RefSeq viral genomes in SQLite database
- 8 curated body site collections with literature-validated compositions
- ICTV taxonomy integration (53.9% coverage)
- Database-driven FASTQ generation with InSilicoSeq
- VLP enrichment modeling with 5 protocols (tangential flow, syringe, ultracentrifugation, Norgen, bulk)
- Type-specific contamination reduction (host DNA, rRNA, bacteria, PhiX)
- Complete ground truth metadata for benchmarking
- Pipeline-independent validation suite

## Database Infrastructure

### SQLite Database
- Location: `viroforge/data/viral_genomes.db`
- 14,423 viral genomes from RefSeq
- ICTV taxonomy annotations
- Indexed for efficient queries
- Quality filters: completeness, length (1-500kb), GC (15-75%), ambiguous bases (<5%)

### Curated Collections (8 Body Sites)
| ID | Collection | Genomes | Environment |
|----|------------|---------|-------------|
| 9 | Gut Virome (Adult Healthy) | 134 | Human gut |
| 10 | Oral Virome (Saliva) | 47 | Human oral |
| 11 | Skin Virome (Sebaceous) | 15 | Human skin |
| 12 | Respiratory Virome (Nasopharynx) | 41 | Human respiratory |
| 13 | Marine Virome (Coastal Surface) | 448 | Marine |
| 14 | Soil Virome (Agricultural) | 291 | Soil |
| 15 | Freshwater Virome (Lake Surface) | 200 | Freshwater |
| 16 | Mouse Gut Virome (C57BL/6) | 22 | Mouse gut |

## Key File Locations

### Core Code
- `viroforge/core/community.py` - Viral community composition
- `viroforge/core/contamination.py` - Contamination profiles (host DNA, rRNA, bacteria, PhiX)
- `viroforge/enrichment/vlp.py` - VLP enrichment with size-based filtration
- `viroforge/simulators/illumina.py` - FASTQ generation
- `viroforge/utils/validation.py` - Quality control framework
- `viroforge/data/database_schema.py` - Database schema and queries

### FASTQ Generation Scripts
- `scripts/generate_fastq_dataset.py` - Single collection FASTQ generation
- `scripts/batch_generate_fastq.py` - Batch generation with 6 presets
- `scripts/validate_fastq_dataset.py` - Pipeline-independent validation
- `scripts/README_FASTQ_GENERATION.md` - Complete usage guide

### Database Tools
- `scripts/viroforge_db.py` - Interactive database browser
- `scripts/viroforge_search.py` - Search by taxonomy
- `scripts/viroforge_qc.py` - Database quality metrics
- `scripts/viroforge_compare.py` - Compare collections
- `scripts/viroforge_subset.py` - Create custom collections
- `scripts/README_EXPLORATION_TOOLS.md` - Tool documentation

### Collection Curation
- `scripts/curate_body_site_collections.py` - Collection creation
- `scripts/validate_body_site_collections.py` - Collection validation
- `data/validation_reports/` - Per-collection validation reports

### Documentation
- `docs/QUICKSTART.md` - Quick start guide
- `docs/COLLECTION_IMPLEMENTATION_GUIDE.md` - Collection curation rationale
- `docs/GENOME_DATABASE_DESIGN.md` - Database schema
- `docs/PHASE4_FASTQ_GENERATION.md` - FASTQ generation workflow
- `docs/PHASE5_TASK1_VLP_ENRICHMENT.md` - VLP enrichment implementation
- `docs/PHASE5_TASK2_FASTQ_INTEGRATION.md` - VLP integration guide
- `docs/PHASE5_TASK3_VALIDATION_REPORT.md` - Comprehensive validation
- `docs/VLP_CONTAMINATION_INTEGRATION.md` - Usage guide
- `docs/VALIDATION_TEST_SUITE.md` - Pipeline validation guide

### Tests
- `tests/test_vlp_contamination.py` - 16 unit tests for VLP/contamination
- `tests/test_fastq_integration.py` - 12 integration tests for FASTQ workflow

## Quick Start

### Generate FASTQ Datasets

```bash
# List available collections
python scripts/generate_fastq_dataset.py --list-collections

# Generate gut virome with VLP enrichment
python scripts/generate_fastq_dataset.py \
    --collection-id 9 \
    --output gut_virome_10x \
    --coverage 10 \
    --vlp-protocol tangential_flow

# Generate bulk metagenome (no VLP)
python scripts/generate_fastq_dataset.py \
    --collection-id 9 \
    --output gut_bulk_10x \
    --coverage 10 \
    --no-vlp

# Batch generation - VLP protocol comparison
python scripts/batch_generate_fastq.py \
    --preset vlp-protocol-comparison \
    --output data/vlp_comparison
```

### Explore Database

```bash
# Interactive browser
python scripts/viroforge_db.py

# Search by taxonomy
python scripts/viroforge_search.py --family Siphoviridae

# Compare collections
python scripts/viroforge_compare.py --collections 9 13
```

## Architecture Principles

- **Database-driven**: All genomes from RefSeq with ICTV taxonomy
- **Literature-validated**: Parameters and compositions based on published studies
- **Modular**: Independent components for flexibility
- **Complete ground truth**: Full metadata including contaminants for benchmarking
- **Reproducible**: Random seeds and versioned database
- **Thread-safe**: Local RNG for parallel workflows

## Key Design Decisions

### Abundance Assignment
Collections use structured random tiered distributions (NOT metagenomic-derived):
- Tier 1 (Dominant): 10-30% relative abundance
- Tier 2 (Common): 1-10%
- Tier 3 (Moderate): 0.1-1%
- Tier 4 (Rare): 0.01-0.1%
- Tier 5 (Very Rare): <0.01%

Rationale: Controlled benchmarking with known sensitivity/specificity, avoiding metagenomics circular dependency.

### VLP Enrichment Modeling
Literature-based size-dependent enrichment (Phase 5):
- Virion size estimation from genome length and type
- Protocol-specific filtration curves (tangential flow, syringe, ultracentrifugation, Norgen, bulk)
- Type-specific contamination reduction:
  - Host DNA: 95-99% reduction (DNase)
  - rRNA: 90-98% reduction (size-based)
  - Bacteria: 85-95% reduction (filtration)
  - PhiX: 0-20% reduction (treated as small virus)
- Validated against literature (Lim et al. 2020, Thurber et al. 2009, Reyes et al. 2012)

### Coverage Calculation
```
n_reads = (total_genome_length * coverage) / (2 * read_length)
```
Factor of 2 accounts for paired-end reads.

## Dependencies

```bash
# Python packages (required)
pip install biopython numpy pandas

# InSilicoSeq (required for FASTQ generation)
conda install -c bioconda insilicoseq

# Testing (optional)
pip install pytest
```

## Testing

### Unit Tests
```bash
# VLP and contamination modeling
pytest tests/test_vlp_contamination.py -v
# Result: 16/16 passing
```

### Integration Tests
```bash
# FASTQ workflow (requires InSilicoSeq)
pytest tests/test_fastq_integration.py -v
# Result: 12 tests (3 dry-run pass without ISS)
```

### Validation
```bash
# Validate generated dataset
python scripts/validate_fastq_dataset.py \
    --dataset output_dir \
    --verbose
```

## Lab Notebook System

ViroForge uses a structured lab notebook for development tracking:
- Location: `lab-notebook/`
- Index: `lab-notebook/INDEX.md`
- Recent entries: `lab-notebook/sessions/2025-11/`
- Pre-commit hooks enforce notebook entries for code changes

## Next Development Opportunities

### Potential Phase 6 Enhancements
If needed for broader community adoption:

1. **Additional Collections**
   - Different diet profiles (Western, Mediterranean, vegan)
   - Wastewater viromes
   - Plant-associated viromes
   - Extreme environments (hot springs, deep sea)

2. **Advanced Features**
   - Temporal dynamics (viral turnover)
   - Multi-sample studies (longitudinal, case-control)
   - Custom collection creation UI
   - Integration with virome analysis pipelines

3. **Validation Extensions**
   - Real dataset comparisons
   - Community benchmarking studies
   - Pipeline parameter optimization
   - Detection limit studies

### Current Production Use
ViroForge is production-ready for:
- Benchmarking virome analysis pipelines
- Sensitivity/specificity studies
- VLP protocol comparison
- Method development and validation
- Training datasets
