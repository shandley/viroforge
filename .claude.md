# ViroForge Development Context

## Project Overview
Synthetic virome data generator for benchmarking and validation of virome analysis pipelines. Generates realistic Illumina reads with known ground truth from curated viral genome collections.

## Current Status (Phase 5: Enhanced VLP Modeling - In Progress)

### Production Ready
- **14,423 RefSeq viral genomes** in SQLite database
- **8 curated body site collections** with literature-validated compositions
- **Database-driven FASTQ generation** with InSilicoSeq integration
- **Complete ground truth metadata** for benchmarking studies
- **8 benchmark datasets** generated and validated (841 MB)
- **Pipeline-independent validation suite** for virome research community
- **Enhanced VLP enrichment module** with size-based filtration (NEW)

### Phase Completion
- Phase 1: Community composition and contamination (100%)
- Phase 2: VLP enrichment and virome-specific features (100%)
- Phase 3: Genome database and body site collections (100%)
- Phase 4: Database-driven FASTQ generation (100%)
- Phase 5: Enhanced VLP modeling (30% - core module complete)

## Key Features

### Database Infrastructure
- **SQLite database**: 14,423 viral genomes from RefSeq
- **ICTV taxonomy**: Integrated with 53.9% coverage
- **Efficient queries**: Indexed for fast genome retrieval
- **Quality filtering**: Genomes validated for completeness

### Curated Collections (8 Body Sites)
| ID | Collection | Genomes | Environment |
|----|------------|---------|-------------|
| 9 | Gut Virome (Adult Healthy) | 134 | Human gut |
| 10 | Oral Virome (Saliva) | 47 | Human oral |
| 11 | Skin Virome (Sebaceous) | 15 | Human skin |
| 12 | Respiratory Virome (Nasopharynx) | 41 | Human respiratory |
| 13 | Marine Virome (Coastal Surface) | 448 | Marine |
| 14 | Soil Virome (Agricultural) | 291 | Soil |
| 15 | Freshwater Virome (Lake Surface) | 200 | Freshwater |
| 16 | Mouse Gut Virome (C57BL/6) | 22 | Mouse gut |

### FASTQ Generation Workflow
- **Single collection**: `scripts/generate_fastq_dataset.py`
- **Batch processing**: `scripts/batch_generate_fastq.py` with 5 presets
- **Platform support**: NovaSeq, MiSeq, HiSeq error models
- **VLP enrichment**: Simulated abundance adjustments
- **Ground truth export**: Complete metadata (JSON, TSV)

## Important Files

### Database and Collections
- `viroforge/data/viral_genomes.db` - SQLite database (14,423 genomes)
- `scripts/curate_body_site_collections.py` - Collection curation
- `scripts/validate_body_site_collections.py` - Collection validation
- `data/validation_reports/` - Per-collection validation reports

### FASTQ Generation Scripts
- `scripts/generate_fastq_dataset.py` - Single collection FASTQ generation
- `scripts/batch_generate_fastq.py` - Batch generation with presets
- `scripts/validate_fastq_dataset.py` - Pipeline-independent validation (9 tests)
- `scripts/README_FASTQ_GENERATION.md` - Complete usage documentation

### Database Exploration Tools
- `scripts/viroforge_db.py` - Interactive database browser
- `scripts/viroforge_search.py` - Search genomes by taxonomy
- `scripts/viroforge_qc.py` - Database quality metrics
- `scripts/viroforge_compare.py` - Compare collections
- `scripts/viroforge_subset.py` - Create custom collections
- `scripts/README_EXPLORATION_TOOLS.md` - Tool documentation

### Core Code
- `viroforge/core/community.py` - Viral community composition
- `viroforge/core/contamination.py` - Contamination profiles
- `viroforge/simulators/illumina.py` - FASTQ generation
- `viroforge/utils/validation.py` - Quality control framework
- `viroforge/enrichment/vlp.py` - Enhanced VLP enrichment modeling (NEW)

### Documentation
- `docs/QUICKSTART.md` - Quick start guide
- `docs/COLLECTION_IMPLEMENTATION_GUIDE.md` - Collection curation rationale
- `docs/PHASE4_FASTQ_GENERATION.md` - FASTQ generation guide
- `docs/GENOME_DATABASE_DESIGN.md` - Database schema
- `docs/VLP_ENRICHMENT_BIOLOGY.md` - VLP enrichment modeling
- `docs/VALIDATION_TEST_SUITE.md` - Pipeline-independent validation guide (NEW)
- `scripts/README_FASTQ_GENERATION.md` - Script usage guide

## Quick Start

### Generate FASTQ from Collection

```bash
# Activate environment
source venv/bin/activate

# List available collections
python scripts/generate_fastq_dataset.py --list-collections

# Generate gut virome at 10x coverage
python scripts/generate_fastq_dataset.py \
    --collection-id 9 \
    --output my_first_virome \
    --coverage 10

# Generate all 8 collections (benchmark suite)
python scripts/batch_generate_fastq.py \
    --preset benchmark-standard \
    --output data/benchmark_datasets
```

### Validate Generated Datasets

```bash
# Validate a dataset (pipeline-independent)
python scripts/validate_fastq_dataset.py \
    --dataset data/benchmark_datasets/collection_16_cov10x_novaseq_vlp \
    --verbose
```

### Explore Database

```bash
# Interactive database browser
python scripts/viroforge_db.py --database viroforge/data/viral_genomes.db

# Search by taxonomy
python scripts/viroforge_search.py \
    --database viroforge/data/viral_genomes.db \
    --family Siphoviridae

# Compare collections
python scripts/viroforge_compare.py \
    --database viroforge/data/viral_genomes.db \
    --collections 9 10
```

## Next Steps

### Phase 5: Enhanced VLP Modeling (In Progress - 30% Complete)

**Completed:**
- Virion size estimation from genome properties (dsDNA, ssDNA, dsRNA, ssRNA)
- Size-based filtration curves (sigmoid, step, linear)
- Protocol-specific VLP models (TFF, syringe, ultracentrifugation, Norgen kit, no VLP)
- VLP enrichment application with size bias (r=0.987 size-enrichment correlation)
- VLP vs bulk comparison workflows

**Remaining (2-3 weeks):**
1. Contamination modeling based on VLP efficiency (2-3 days)
2. FASTQ generation workflow integration (3-4 days)
3. Comprehensive testing and validation (3-4 days)
4. Documentation and examples (2-3 days)
5. New batch generation presets with VLP options (1-2 days)

**Testing Strategy:**
- Unit tests for size estimation and filtration curves
- Integration tests with existing FASTQ generation
- Validation against literature-reported VLP enrichment factors
- Comparison of VLP vs bulk datasets

### Future Enhancements (Optional - Phase 6+)

If needed for broader community use:

1. **Amplification Bias Modeling**
   - RdAB (random displacement amplification)
   - MDA (multiple displacement amplification)
   - Length-dependent bias curves

2. **Platform Artifacts**
   - NovaSeq polyG tails
   - Optical duplicates
   - Index hopping

3. **Additional Body Site Collections**
   - Fecal samples (different diet profiles)
   - Wastewater viromes
   - Plant-associated viromes
   - Extreme environments (hot springs, deep sea)

### Community Validation
- Pipeline-independent validation suite available (9 tests)
- Benchmark datasets ready for community testing
- Ground truth metadata available for sensitivity/specificity analysis

## Architecture Principles

- **Database-driven**: All genomes from RefSeq with ICTV taxonomy
- **Literature-validated**: Collection compositions based on published studies
- **Modular**: Independent components for flexibility
- **Complete ground truth**: Full metadata for validation
- **Reproducible**: Random seeds and versioned database

## Testing Requirements

- Unit tests for validation framework (31/31 passing)
- Collection validation (all 8 collections validated)
- FASTQ generation tested with small subset
- Benchmark datasets generated successfully

## Dependencies

```bash
# Python packages
pip install biopython numpy pandas

# InSilicoSeq for FASTQ generation
conda install -c bioconda insilicoseq
# or
pip install InSilicoSeq
```

## Key Design Decisions

### Abundance Assignment
Collections use **structured random tiered distributions** (NOT metagenomic-derived):
- Tier 1 (Dominant): 10-30% each
- Tier 2 (Common): 1-10% each
- Tier 3 (Moderate): 0.1-1% each
- Tier 4 (Rare): 0.01-0.1% each
- Tier 5 (Very Rare): <0.01% each

Abundances are randomly assigned within tiers, then normalized and shuffled for realism.

### VLP Enrichment Modeling

**Original (Phase 2):** Simple abundance adjustment (~20% increase with variation)
```python
if vlp_enabled:
    abundance *= (1.0 + np.random.normal(0.2, 0.05))
```

**Enhanced (Phase 5 - NEW):** Literature-based size-dependent enrichment
- Virion size estimation from genome length and type (Cui et al. 2014, Nasir et al. 2017)
- Size-based filtration curves (sigmoid, step, linear)
- Protocol-specific parameters (TFF, syringe, ultracentrifugation, column-based)
- Nuclease efficiency: 90-98% depending on protocol
- Recovery rates: 60-90% depending on method
- Contamination reduction: 75-95% depending on method
- Realistic size bias: small viruses depleted, large viruses enriched

### Collection Curation
See `docs/COLLECTION_IMPLEMENTATION_GUIDE.md` for complete rationale:
- Database-driven taxonomy queries (SQL-based)
- RefSeq availability constraints documented
- Literature references for each collection
- Plan vs. implementation differences explained

## Recent Commits
- Enhanced VLP enrichment module (Phase 5 started)
- Pipeline-independent validation suite (9 tests)
- Phase 4 FASTQ generation complete
- 8 benchmark datasets generated and validated
- Complete documentation updates

## Notes
- Database construction scripts in `scripts/` (Phase 3)
- Validation reports in `data/validation_reports/`
- Benchmark datasets in `data/benchmark_datasets/` (gitignored, 841 MB)
- InSilicoSeq uses "basic" mode for speed
- Coverage calculation: `n_reads = (total_length * coverage) / (2 * read_length)`
