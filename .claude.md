# ViroForge Development Context

## Project Overview
Synthetic virome data generator for benchmarking and validation of virome analysis pipelines. Generates realistic Illumina reads with known ground truth from curated viral genome collections.

## Current Status (Phases 3-4: Complete)

### Production Ready
- **14,423 RefSeq viral genomes** in SQLite database
- **8 curated body site collections** with literature-validated compositions
- **Database-driven FASTQ generation** with InSilicoSeq integration
- **Complete ground truth metadata** for benchmarking studies
- **8 benchmark datasets** generated and validated (841 MB)

### Phase Completion
- Phase 1: Community composition and contamination (100%)
- Phase 2: VLP enrichment and virome-specific features (90%)
- Phase 3: Genome database and body site collections (100%)
- Phase 4: Database-driven FASTQ generation (100%)

## Key Features

### Database Infrastructure
- **SQLite database**: 14,423 viral genomes from RefSeq
- **ICTV taxonomy**: Integrated with 53.9% coverage
- **Efficient queries**: Indexed for fast genome retrieval
- **Quality filtering**: Genomes validated for completeness

### Curated Collections (8 Body Sites)
| ID | Collection | Genomes | Environment |
|----|------------|---------|-------------|
| 9 | Gut Virome (Adult Healthy) | 134 | Human gut |
| 10 | Oral Virome (Saliva) | 47 | Human oral |
| 11 | Skin Virome (Sebaceous) | 15 | Human skin |
| 12 | Respiratory Virome (Nasopharynx) | 41 | Human respiratory |
| 13 | Marine Virome (Coastal Surface) | 448 | Marine |
| 14 | Soil Virome (Agricultural) | 291 | Soil |
| 15 | Freshwater Virome (Lake Surface) | 200 | Freshwater |
| 16 | Mouse Gut Virome (C57BL/6) | 22 | Mouse gut |

### FASTQ Generation Workflow
- **Single collection**: `scripts/generate_fastq_dataset.py`
- **Batch processing**: `scripts/batch_generate_fastq.py` with 5 presets
- **Platform support**: NovaSeq, MiSeq, HiSeq error models
- **VLP enrichment**: Simulated abundance adjustments
- **Ground truth export**: Complete metadata (JSON, TSV)

## Important Files

### Database and Collections
- `viroforge/data/viral_genomes.db` - SQLite database (14,423 genomes)
- `scripts/curate_body_site_collections.py` - Collection curation
- `scripts/validate_body_site_collections.py` - Collection validation
- `data/validation_reports/` - Per-collection validation reports

### FASTQ Generation Scripts
- `scripts/generate_fastq_dataset.py` - Single collection FASTQ generation
- `scripts/batch_generate_fastq.py` - Batch generation with presets
- `scripts/README_FASTQ_GENERATION.md` - Complete usage documentation

### Database Exploration Tools
- `scripts/viroforge_db.py` - Interactive database browser
- `scripts/viroforge_search.py` - Search genomes by taxonomy
- `scripts/viroforge_qc.py` - Database quality metrics
- `scripts/viroforge_compare.py` - Compare collections
- `scripts/viroforge_subset.py` - Create custom collections
- `scripts/README_EXPLORATION_TOOLS.md` - Tool documentation

### Core Code (Original Phases 1-2)
- `viroforge/core/community.py` - Viral community composition
- `viroforge/core/contamination.py` - Contamination profiles
- `viroforge/simulators/illumina.py` - FASTQ generation
- `viroforge/utils/validation.py` - Quality control framework

### Documentation
- `docs/QUICKSTART.md` - Quick start guide
- `docs/COLLECTION_IMPLEMENTATION_GUIDE.md` - Collection curation rationale
- `docs/PHASE4_FASTQ_GENERATION.md` - FASTQ generation guide
- `docs/GENOME_DATABASE_DESIGN.md` - Database schema
- `docs/VLP_ENRICHMENT_BIOLOGY.md` - VLP enrichment modeling
- `scripts/README_FASTQ_GENERATION.md` - Script usage guide

## Quick Start

### Generate FASTQ from Collection

```bash
# Activate environment
source venv/bin/activate

# List available collections
python scripts/generate_fastq_dataset.py --list-collections

# Generate gut virome at 10x coverage
python scripts/generate_fastq_dataset.py \
    --collection-id 9 \
    --output my_first_virome \
    --coverage 10

# Generate all 8 collections (benchmark suite)
python scripts/batch_generate_fastq.py \
    --preset benchmark-standard \
    --output data/benchmark_datasets
```

### Explore Database

```bash
# Interactive database browser
python scripts/viroforge_db.py --database viroforge/data/viral_genomes.db

# Search by taxonomy
python scripts/viroforge_search.py \
    --database viroforge/data/viral_genomes.db \
    --family Siphoviridae

# Compare collections
python scripts/viroforge_compare.py \
    --database viroforge/data/viral_genomes.db \
    --collections 9 10
```

## Next Steps (Optional Enhancements)

### Phase 5: Advanced Features (Future)
If needed for broader community use:

1. **Enhanced VLP Modeling**
   - More sophisticated size-based filtration
   - Protocol-specific efficiency curves
   - VLP vs bulk comparison workflows

2. **Amplification Bias**
   - RdAB (random displacement amplification)
   - MDA (multiple displacement amplification)
   - Length-dependent bias modeling

3. **Platform Artifacts**
   - NovaSeq polyG tails
   - Optical duplicates
   - Index hopping

4. **Additional Collections**
   - Fecal samples (different diet profiles)
   - Wastewater
   - Plant-associated viromes
   - Extreme environments

### Integration and Validation
- Test benchmark datasets with Hecatomb pipeline
- Generate performance metrics (sensitivity, specificity)
- Compare to published virome studies
- Document benchmarking workflows

## Architecture Principles

- **Database-driven**: All genomes from RefSeq with ICTV taxonomy
- **Literature-validated**: Collection compositions based on published studies
- **Modular**: Independent components for flexibility
- **Complete ground truth**: Full metadata for validation
- **Reproducible**: Random seeds and versioned database

## Testing Requirements

- Unit tests for validation framework (31/31 passing)
- Collection validation (all 8 collections validated)
- FASTQ generation tested with small subset
- Benchmark datasets generated successfully

## Dependencies

```bash
# Python packages
pip install biopython numpy pandas

# InSilicoSeq for FASTQ generation
conda install -c bioconda insilicoseq
# or
pip install InSilicoSeq
```

## Key Design Decisions

### Abundance Assignment
Collections use **structured random tiered distributions** (NOT metagenomic-derived):
- Tier 1 (Dominant): 10-30% each
- Tier 2 (Common): 1-10% each
- Tier 3 (Moderate): 0.1-1% each
- Tier 4 (Rare): 0.01-0.1% each
- Tier 5 (Very Rare): <0.01% each

Abundances are randomly assigned within tiers, then normalized and shuffled for realism.

### VLP Enrichment Simulation
Simple abundance adjustment (~20% increase with variation):
```python
if vlp_enabled:
    abundance *= (1.0 + np.random.normal(0.2, 0.05))
```
Then renormalized. More sophisticated modeling available if needed.

### Collection Curation
See `docs/COLLECTION_IMPLEMENTATION_GUIDE.md` for complete rationale:
- Database-driven taxonomy queries (SQL-based)
- RefSeq availability constraints documented
- Literature references for each collection
- Plan vs. implementation differences explained

## Recent Commits
- Phase 4 FASTQ generation complete
- 8 benchmark datasets generated
- Complete documentation updates
- Collection implementation guide created

## Notes
- Database construction scripts in `scripts/` (Phase 3)
- Validation reports in `data/validation_reports/`
- Benchmark datasets in `data/benchmark_datasets/` (gitignored, 841 MB)
- InSilicoSeq uses "basic" mode for speed
- Coverage calculation: `n_reads = (total_length * coverage) / (2 * read_length)`
