{% extends "base.html" %}

{% block title %}Dataset Reports{% endblock %}

{% block content %}
<div class="container my-5">
    <h1><i class="bi bi-file-earmark-text"></i> Dataset Reports</h1>
    <p class="text-muted">View quality metrics and composition for generated datasets</p>

    <div class="card mt-4">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Dataset Path</label>
                <input type="text" id="datasetPath" class="form-control" placeholder="data/gut-standard">
            </div>
            <button class="btn btn-vf-primary" onclick="loadReport()">
                <i class="bi bi-search"></i> Load Report
            </button>
        </div>
    </div>

    <div id="reportCard" class="card mt-4 d-none">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-file-text"></i> <span id="reportTitle">Dataset Report</span></h5>
        </div>
        <div class="card-body" id="reportBody"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadReport() {
    const path = document.getElementById('datasetPath').value;
    if (!path) return;

    fetch('/api/report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dataset_path: path})
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('reportCard').classList.remove('d-none');
        document.getElementById('reportTitle').textContent = data.dataset_name;

        let html = `
            <h6>Generation Summary</h6>
            <table class="table table-sm">
                <tr><th>Collection</th><td>${data.metadata.collection?.name || 'N/A'}</td></tr>
                <tr><th>Platform</th><td>${data.metadata.platform?.name?.toUpperCase() || 'N/A'}</td></tr>
                <tr><th>Generated</th><td>${data.metadata.generation_info?.timestamp || 'N/A'}</td></tr>
                <tr><th>Random Seed</th><td>${data.metadata.generation_info?.random_seed || 'N/A'}</td></tr>
            </table>

            <h6 class="mt-4">Genome Composition</h6>
        `;

        if (data.composition && data.composition.length > 0) {
            const sorted = data.composition.sort((a, b) => b.relative_abundance - a.relative_abundance);
            html += `<table class="table table-sm">
                <thead><tr><th>Rank</th><th>Genome</th><th>Abundance</th></tr></thead>
                <tbody>`;
            sorted.slice(0, 5).forEach((g, i) => {
                html += `<tr><td>${i+1}</td><td>${g.genome_name || g.genome_id}</td><td>${(g.relative_abundance*100).toFixed(2)}%</td></tr>`;
            });
            html += '</tbody></table>';
        }

        document.getElementById('reportBody').innerHTML = html;
    })
    .catch(error => {
        alert('Error loading report: ' + error.message);
    });
}
</script>
{% endblock %}
